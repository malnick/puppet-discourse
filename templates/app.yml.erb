##########################
# Managed by Your Mother #
##########################
templates:
  - "templates/postgres.template.yml"
  - "templates/redis.template.yml"
  - "templates/web.template.yml"
  - "templates/sshd.template.yml"
  - "templates/web.ratelimited.template.yml"
<% if @ssl_enabled -%>
  - "templates/web.ssl.template.yml"
<% end -%>

expose:
  - "80:80"   
  - "2222:22" 
<% if @ssl_enabled -%>
  - "443:443"
<% end -%>

params:
  db_default_text_search_config: "pg_catalog.english"
  db_shared_buffers: "1GB"
  version: tests-passed
env:
  LANG: en_US.UTF-8
  UNICORN_WORKERS: 3
  DISCOURSE_DEVELOPER_EMAILS: <%= @discourse_email %> 
  DISCOURSE_HOSTNAME: <%= @discourse_hostname %> 
  DISCOURSE_SMTP_ADDRESS: <%= @discourse_smtp %> 
  #DISCOURSE_SMTP_PORT: 587                 
  DISCOURSE_SMTP_USER_NAME: <%= @smtp_user %> 
  DISCOURSE_SMTP_PASSWORD: <%= @smtp_pw %>

## These containers are stateless, all data is stored in /shared
volumes:
  - volume:
      host: <%= @discourse_root %>/shared/standalone
      guest: /shared
  - volume:
      host: <%= @discourse_root %>/standalone/log/var-log
      guest: /var/log
hooks:
  after_code:
    - exec:
        cd: $home/plugins
        cmd:
          - mkdir -p plugins
<% @plugins.each do |p| -%>
          - git clone https://github.com/<%= p %>.git
<% end -%>
run:
  - exec: echo "Beginning of custom commands"
  - exec: echo "End of custom commands"
  - exec: awk -F\# '{print $1;}' ~/.ssh/authorized_keys | awk 'BEGIN { print "Authorized SSH keys for this container:"; } NF>=2 {print $NF;}'
